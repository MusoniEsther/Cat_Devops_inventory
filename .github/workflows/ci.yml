name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML Files
      run: |
        echo "ğŸ” Validating HTML structure..."
        for file in *.html; do
          echo "Checking $file"
          if grep -q "<!DOCTYPE html>" "$file"; then
            echo "âœ… $file has valid DOCTYPE"
          else
            echo "âŒ $file missing DOCTYPE"
            exit 1
          fi
        done
    
    - name: Check JavaScript Quality
      run: |
        echo "ğŸ” Checking JavaScript syntax..."
        grep -r "console.log\|console.error" . --include="*.html" || echo "âœ… Code quality checks passed"

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Dependencies
      run: npm install
    
    - name: Verify HTML Files Exist
      run: |
        echo "âœ… Checking required files..."
        [ -f "index.html" ] && echo "âœ… index.html found" || (echo "âŒ index.html missing" && exit 1)
        [ -f "dashboard.html" ] && echo "âœ… dashboard.html found" || (echo "âŒ dashboard.html missing" && exit 1)
    
    - name: Check localStorage Implementation
      run: |
        echo "âœ… Validating localStorage usage..."
        grep -r "localStorage" . --include="*.html" && echo "âœ… localStorage properly configured"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for Sensitive Data
      run: |
        echo "ğŸ”’ Scanning for exposed secrets..."
        if grep -r "password.*=" . --include="*.html" | grep -v "id\|placeholder\|type="; then
          echo "âš ï¸  Review hardcoded credentials"
        else
          echo "âœ… No obvious exposed credentials"
        fi

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Build Artifacts
      run: |
        echo "ğŸ”¨ Building project..."
        mkdir -p build
        cp *.html build/
        cp index.js build/ 2>/dev/null || true
        cp server.js build/ 2>/dev/null || true
        cp package.json build/ 2>/dev/null || true
        cp Dockerfile build/ 2>/dev/null || true
        echo "âœ… Build completed successfully"
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: inventory-system
        path: build/
        retention-days: 7

  success:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: success()
    
    steps:
    - name: âœ… CI Pipeline Success
      run: |
        echo "âœ… CI Pipeline Completed Successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "All checks passed!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
