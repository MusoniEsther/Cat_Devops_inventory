name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML Files
      run: |
        echo "üîç Validating HTML structure..."
        for file in *.html; do
          echo "Checking $file"
          if grep -q "<!DOCTYPE html>" "$file"; then
            echo "‚úÖ $file has valid DOCTYPE"
          else
            echo "‚ùå $file missing DOCTYPE"
            exit 1
          fi
        done
    
    - name: Check JavaScript Quality
      run: |
        echo "üîç Checking JavaScript syntax..."
        grep -r "console.log\|console.error" . --include="*.html" || echo "‚úÖ Code quality checks passed"

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Verify HTML Files Exist
      run: |
        echo "‚úÖ Checking required files..."
        [ -f "index.html" ] && echo "‚úÖ index.html found" || (echo "‚ùå index.html missing" && exit 1)
        [ -f "dashboard.html" ] && echo "‚úÖ dashboard.html found" || (echo "‚ùå dashboard.html missing" && exit 1)
    
    - name: Check localStorage Implementation
      run: |
        echo "‚úÖ Validating localStorage usage..."
        grep -r "localStorage" . --include="*.html" && echo "‚úÖ localStorage properly configured"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for Sensitive Data
      run: |
        echo "üîí Scanning for exposed secrets..."
        if grep -r "password.*=" . --include="*.html" | grep -v "id\|placeholder\|type="; then
          echo "‚ö†Ô∏è  Review hardcoded credentials"
        else
          echo "‚úÖ No obvious exposed credentials"
        fi

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Build Artifacts
      run: |
        echo "üî® Building project..."
        mkdir -p build
        cp *.html build/
        cp index.js build/ 2>/dev/null || true
        cp server.js build/ 2>/dev/null || true
        cp package.json build/ 2>/dev/null || true
        cp Dockerfile build/ 2>/dev/null || true
        echo "‚úÖ Build completed successfully"
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: inventory-system
        path: build/
        retention-days: 7

  notify-slack:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
    - name: Send Slack Notification
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "‚ö†Ô∏è  Slack webhook not configured"
          exit 0
        fi

        # Determine status and color
        if [ "${{ needs.build.result }}" = "success" ]; then
          STATUS="SUCCESS"
          COLOR="36a64f"
          EMOJI="‚úÖ"
        else
          STATUS="FAILED"
          COLOR="ff0000"
          EMOJI="‚ùå"
        fi

        # Create Slack payload
        PAYLOAD=$(cat <<'EOF'
        {
          "text": "GitHub Actions CI Pipeline",
          "attachments": [
            {
              "fallback": "GitHub Actions Notification",
              "color": "$COLOR",
              "title": "$EMOJI CI Pipeline - $STATUS",
              "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "${{ github.sha }}",
                  "short": false
                },
                {
                  "title": "Author",
                  "value": "${{ github.actor }}",
                  "short": true
                },
                {
                  "title": "Workflow",
                  "value": "${{ github.workflow }}",
                  "short": true
                }
              ],
              "actions": [
                {
                  "type": "button",
                  "text": "View Workflow Logs",
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ],
              "footer": "GitHub Actions",
              "ts": $(date +%s)
            }
          ]
        }
        EOF
        )

        # Send to Slack
        curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$SLACK_WEBHOOK_URL" \
          -w "\n"

        echo "‚úÖ Slack notification sent"

  success:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, notify-slack]
    if: success()
    
    steps:
    - name: ‚úÖ CI Pipeline Success
      run: |
        echo "‚úÖ CI Pipeline Completed Successfully!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìã All Checks Passed:"
        echo "  ‚úÖ Lint: HTML & JavaScript validation"
        echo "  ‚úÖ Test: File & functionality checks"
        echo "  ‚úÖ Security: Data exposure scanning"
        echo "  ‚úÖ Build: Artifact creation"
        echo "  ‚úÖ Notify: Slack notification sent"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
