name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML Files
      run: |
        echo "üîç Validating HTML structure..."
        for file in *.html; do
          echo "Checking $file"
          if grep -q "<!DOCTYPE html>" "$file"; then
            echo "‚úÖ $file has valid DOCTYPE"
          else
            echo "‚ùå $file missing DOCTYPE"
            exit 1
          fi
        done
    
    - name: Check JavaScript Quality
      run: |
        echo "üîç Checking JavaScript syntax..."
        grep -r "console.log\|console.error" . --include="*.html" || echo "‚úÖ Code quality checks passed"
    
    - name: Validate File References
      run: |
        echo "üîç Checking file references..."
        grep -r "window.location.href\|href=" . --include="*.html" | grep -E "(index\.html|dashboard\.html)" && echo "‚úÖ File references are correct"

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Verify HTML Files Exist
      run: |
        echo "‚úÖ Checking required files..."
        [ -f "index.html" ] && echo "‚úÖ index.html found" || (echo "‚ùå index.html missing" && exit 1)
        [ -f "dashboard.html" ] && echo "‚úÖ dashboard.html found" || (echo "‚ùå dashboard.html missing" && exit 1)
    
    - name: Check localStorage Implementation
      run: |
        echo "‚úÖ Validating localStorage usage..."
        grep -r "localStorage" . --include="*.html" && echo "‚úÖ localStorage properly configured"
    
    - name: Verify Navigation Paths
      run: |
        echo "‚úÖ Verifying navigation paths..."
        grep -q "window.location.href = 'dashboard.html'" index.html && echo "‚úÖ Login redirect correct"
        grep -q "window.location.href = 'index.html'" dashboard.html && echo "‚úÖ Logout redirect correct"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for Sensitive Data
      run: |
        echo "üîí Scanning for exposed secrets..."
        if grep -r "password.*=" . --include="*.html" | grep -v "id\|placeholder\|type="; then
          echo "‚ö†Ô∏è  Review hardcoded credentials"
        else
          echo "‚úÖ No obvious exposed credentials"
        fi
    
    - name: Validate Form Inputs
      run: |
        echo "üîí Checking form security..."
        grep -r "autocomplete\|type=" . --include="*.html" | grep -q "password" && echo "‚úÖ Password fields secured"

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Build Artifacts
      run: |
        echo "üî® Building project..."
        mkdir -p build
        cp *.html build/
        cp index.js build/ 2>/dev/null || true
        cp server.js build/ 2>/dev/null || true
        cp package.json build/ 2>/dev/null || true
        cp Dockerfile build/ 2>/dev/null || true
        echo "‚úÖ Build completed successfully"
    
    - name: List Artifacts
      run: |
        echo "üì¶ Build artifacts:"
        ls -lah build/
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: inventory-system
        path: build/
        retention-days: 7

  notify:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Notify Slack (All Conditions)
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          STATUS="success"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="${{ job.status }}"
          fi
          
          BRANCH="${{ github.ref_name }}"
          AUTHOR="${{ github.actor }}"
          WORKFLOW="${{ github.workflow }}"
          COMMIT="${{ github.sha }}"
          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"
          SERVER_URL="${{ github.server_url }}"
          
          # Determine emoji based on status
          case "$STATUS" in
            success)
              EMOJI=":white_check_mark:"
              COLOR="good"
              ;;
            failure)
              EMOJI=":x:"
              COLOR="danger"
              ;;
            cancelled)
              EMOJI=":warning:"
              COLOR="warning"
              ;;
            *)
              EMOJI=":grey_question:"
              COLOR="#808080"
              ;;
          esac
          
          # Create payload
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "$EMOJI CI Pipeline - $STATUS",
                "fields": [
                  {
                    "title": "Workflow",
                    "value": "$WORKFLOW",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "$BRANCH",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "$AUTHOR",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${COMMIT:0:7}",
                    "short": true
                  },
                  {
                    "title": "Repository",
                    "value": "$REPO",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "$STATUS",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Logs",
                    "url": "$SERVER_URL/$REPO/actions/runs/$RUN_ID"
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" || true
        else
          echo "‚ÑπÔ∏è  No Slack webhook configured."
        fi

  success:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, notify]
    if: success()
    
    steps:
    - name: ‚úÖ CI Pipeline Success
      run: |
        echo "‚úÖ CI Pipeline Completed Successfully!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìã All Checks Passed:"
        echo "  ‚úÖ Lint: HTML & JavaScript validation"
        echo "  ‚úÖ Test: File & functionality checks"
        echo "  ‚úÖ Security: Data exposure scanning"
        echo "  ‚úÖ Build: Artifact creation"
        echo "  ‚úÖ Notify: Slack notification sent"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
