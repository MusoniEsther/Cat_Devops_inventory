name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML Files
      run: |
        echo "üîç Validating HTML structure..."
        for file in *.html; do
          echo "Checking $file"
          if grep -q "<!DOCTYPE html>" "$file"; then
            echo "‚úÖ $file has valid DOCTYPE"
          else
            echo "‚ùå $file missing DOCTYPE"
            exit 1
          fi
        done
    
    - name: Check JavaScript Quality
      run: |
        echo "üîç Checking JavaScript syntax..."
        grep -r "console.log\|console.error" . --include="*.html" || echo "‚úÖ Code quality checks passed"

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Verify HTML Files Exist
      run: |
        echo "‚úÖ Checking required files..."
        [ -f "index.html" ] && echo "‚úÖ index.html found" || (echo "‚ùå index.html missing" && exit 1)
        [ -f "dashboard.html" ] && echo "‚úÖ dashboard.html found" || (echo "‚ùå dashboard.html missing" && exit 1)
    
    - name: Check localStorage Implementation
      run: |
        echo "‚úÖ Validating localStorage usage..."
        grep -r "localStorage" . --include="*.html" && echo "‚úÖ localStorage properly configured"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for Sensitive Data
      run: |
        echo "üîí Scanning for exposed secrets..."
        if grep -r "password.*=" . --include="*.html" | grep -v "id\|placeholder\|type="; then
          echo "‚ö†Ô∏è  Review hardcoded credentials"
        else
          echo "‚úÖ No obvious exposed credentials"
        fi

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Build Artifacts
      run: |
        echo "üî® Building project..."
        mkdir -p build
        cp *.html build/
        cp index.js build/ 2>/dev/null || true
        cp server.js build/ 2>/dev/null || true
        cp package.json build/ 2>/dev/null || true
        cp Dockerfile build/ 2>/dev/null || true
        echo "‚úÖ Build completed successfully"
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: inventory-system
        path: build/
        retention-days: 7

  notify-slack:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
    - name: Send Slack Notification
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        BUILD_STATUS: ${{ needs.build.result }}
        REPO: ${{ github.repository }}
        BRANCH: ${{ github.ref_name }}
        AUTHOR: ${{ github.actor }}
        COMMIT: ${{ github.sha }}
        RUN_ID: ${{ github.run_id }}
        SERVER_URL: ${{ github.server_url }}
      run: |
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "‚ö†Ô∏è  Slack webhook not configured"
          exit 0
        fi

        if [ "$BUILD_STATUS" = "success" ]; then
          STATUS_TEXT="‚úÖ SUCCESS"
          COLOR="36a64f"
        else
          STATUS_TEXT="‚ùå FAILED"
          COLOR="danger"
        fi

        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d @- <<EOF
        {
          "attachments": [
            {
              "color": "$COLOR",
              "title": "CI Pipeline - $STATUS_TEXT",
              "text": "Build Status Update",
              "fields": [
                {
                  "title": "Repository",
                  "value": "$REPO",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "$BRANCH",
                  "short": true
                },
                {
                  "title": "Author",
                  "value": "$AUTHOR",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "${COMMIT:0:7}",
                  "short": true
                }
              ],
              "actions": [
                {
                  "type": "button",
                  "text": "View Workflow",
                  "url": "$SERVER_URL/$REPO/actions/runs/$RUN_ID"
                }
              ],
              "footer": "GitHub Actions"
            }
          ]
        }
        EOF

        echo "‚úÖ Slack message sent successfully"

  success:
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, notify-slack]
    if: success()
    
    steps:
    - name: ‚úÖ CI Pipeline Success
      run: |
        echo "‚úÖ CI Pipeline Completed Successfully!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìã All Checks Passed:"
        echo "  ‚úÖ Lint: HTML & JavaScript validation"
        echo "  ‚úÖ Test: File & functionality checks"
        echo "  ‚úÖ Security: Data exposure scanning"
        echo "  ‚úÖ Build: Artifact creation"
        echo "  ‚úÖ Notify: Slack notification sent"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
